# Build Screenpipe (submodule) on Windows and upload the installer .exe.
# Uses whatever screenpipe commit is pinned in this repo (git submodule).
# To build a newer Screenpipe: update the submodule, commit, push; then run this workflow.
name: Build Screenpipe (Windows)

on:
  workflow_dispatch:
    inputs:
      create_release:
        description: "Create a GitHub Release and attach the .exe (draft)"
        type: boolean
        default: false
  push:
    branches: [main]
    tags: ["v*"]

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 120
    permissions:
      contents: write  # for creating release when tag v*
    steps:
      - name: Enable Git long paths
        shell: powershell
        run: |
          git config --global core.longpaths true

      - name: Checkout (with submodule)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.2"

      - name: Install Rust
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://win.rustup.rs/x86_64" -OutFile rustup-init.exe -UseBasicParsing
          .\rustup-init.exe -y
          $env:PATH = "$env:USERPROFILE\.cargo\bin;$env:PATH"
          echo "$env:USERPROFILE\.cargo\bin" >> $env:GITHUB_PATH
          rustc --version

      - name: Set up MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install 7-Zip
        shell: powershell
        run: |
          if (Test-Path "C:\Program Files\7-Zip\7z.exe") { Write-Host "7-Zip already installed" }
          else {
            Invoke-WebRequest -Uri "https://7-zip.org/a/7z2301-x64.exe" -OutFile 7z-installer.exe -UseBasicParsing
            Start-Process -FilePath .\7z-installer.exe -ArgumentList "/S" -Wait -NoNewWindow
            Remove-Item 7z-installer.exe
          }
          echo "C:\Program Files\7-Zip" >> $env:GITHUB_PATH

      - name: Install wget
        shell: powershell
        run: |
          $wgetDir = "C:\wget"
          if (Test-Path "$wgetDir\wget.exe") { Write-Host "wget already installed" }
          else {
            New-Item -ItemType Directory -Force -Path $wgetDir | Out-Null
            Invoke-WebRequest -Uri "https://eternallybored.org/misc/wget/releases/wget-1.21.4-win64.zip" -OutFile "$wgetDir\wget.zip" -UseBasicParsing
            Expand-Archive -Path "$wgetDir\wget.zip" -DestinationPath $wgetDir -Force
            Remove-Item "$wgetDir\wget.zip"
          }
          echo "C:\wget" >> $env:GITHUB_PATH
          & "$wgetDir\wget.exe" --version

      - name: Cache LLVM
        id: cache-llvm
        uses: actions/cache@v4
        with:
          path: "C:\Program Files\LLVM"
          key: llvm-10-windows-recall

      - name: Install LLVM and Clang
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          $llvmPath = "C:\Program Files\LLVM"
          if (Test-Path "$llvmPath\bin\clang.exe") { Write-Host "LLVM already installed"; exit 0 }
          New-Item -ItemType Directory -Force -Path $llvmPath | Out-Null
          $url = "https://github.com/llvm/llvm-project/releases/download/llvmorg-10.0.0/LLVM-10.0.0-win64.exe"
          $out = "$env:TEMP\LLVM-10.0.0-win64.exe"
          Invoke-WebRequest -Uri $url -OutFile $out -UseBasicParsing
          Start-Process -FilePath $out -ArgumentList "/S", "/D=$llvmPath" -Wait -NoNewWindow
          Remove-Item $out -Force
          if (!(Test-Path "$llvmPath\bin\clang.exe")) { throw "LLVM install failed" }
          Write-Host "LIBCLANG_PATH=$llvmPath\bin" >> $env:GITHUB_ENV
          echo "$llvmPath\bin" >> $env:GITHUB_PATH

      - name: Set LIBCLANG_PATH
        if: steps.cache-llvm.outputs.cache-hit == 'true'
        shell: powershell
        run: |
          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" >> $env:GITHUB_ENV

      - name: Setup Python (for MKL)
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: recall-windows-${{ hashFiles('screenpipe/**/Cargo.lock') }}
          cache-directories: |
            screenpipe/target
            screenpipe/apps/screenpipe-app-tauri/src-tauri/target

      - name: Build (setup-screenpipe.ps1)
        shell: powershell
        run: |
          .\scripts\setup-screenpipe.ps1 -SkipPrereqCheck
        env:
          LIBCLANG_PATH: "C:\Program Files\LLVM\bin"

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: screenpipe-installer-windows
          path: screenpipe/apps/screenpipe-app-tauri/src-tauri/target/release/bundle/nsis/*.exe

      - name: Create Release (tag v* or manual with create_release)
        if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          files: screenpipe/apps/screenpipe-app-tauri/src-tauri/target/release/bundle/nsis/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
