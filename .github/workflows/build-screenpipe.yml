# Build Screenpipe (submodule) on Windows and upload the installer .exe.
# Uses whatever screenpipe commit is pinned in this repo (git submodule).
# To build a newer Screenpipe: update the submodule, commit, push; then run this workflow.
name: Build Screenpipe (Windows)

on:
  workflow_dispatch:
    inputs:
      create_release:
        description: "Create a GitHub Release and attach the .exe (draft)"
        type: boolean
        default: false
  push:
    branches: [main]
    tags: ["v*"]

jobs:
  build-windows:
    runs-on: windows-latest
    timeout-minutes: 120
    permissions:
      contents: write  # for creating release when tag v*
    steps:
      - name: Enable Git long paths
        shell: powershell
        run: |
          git config --global core.longpaths true

      - name: Checkout (with submodule)
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.2"

      - name: Install Rust
        shell: powershell
        run: |
          Invoke-WebRequest -Uri "https://win.rustup.rs/x86_64" -OutFile rustup-init.exe -UseBasicParsing
          .\rustup-init.exe -y
          $env:PATH = "$env:USERPROFILE\.cargo\bin;$env:PATH"
          echo "$env:USERPROFILE\.cargo\bin" >> $env:GITHUB_PATH
          rustc --version

      - name: Set up MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Install vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: "7adc2e4d49e8d0efc07a369079faa6bc3dbb90f3"

      - name: Cache vcpkg installed
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/vcpkg/installed
          key: vcpkg-installed-win-${{ hashFiles('screenpipe/Cargo.lock') }}

      - name: Install vcpkg packages (ffmpeg)
        shell: powershell
        run: |
          & "$env:VCPKG_ROOT\vcpkg.exe" install ffmpeg:x64-windows

      - name: Install 7-Zip
        shell: powershell
        run: |
          if (Test-Path "C:\Program Files\7-Zip\7z.exe") { Write-Host "7-Zip already installed" }
          else {
            Invoke-WebRequest -Uri "https://7-zip.org/a/7z2301-x64.exe" -OutFile 7z-installer.exe -UseBasicParsing
            Start-Process -FilePath .\7z-installer.exe -ArgumentList "/S" -Wait -NoNewWindow
            Remove-Item 7z-installer.exe
          }
          echo "C:\Program Files\7-Zip" >> $env:GITHUB_PATH

      - name: Install wget
        shell: powershell
        run: |
          $wgetDir = "C:\wget"
          if (Test-Path "$wgetDir\wget.exe") { Write-Host "wget already installed" }
          else {
            New-Item -ItemType Directory -Force -Path $wgetDir | Out-Null
            Invoke-WebRequest -Uri "https://eternallybored.org/misc/wget/releases/wget-1.21.4-win64.zip" -OutFile "$wgetDir\wget.zip" -UseBasicParsing
            Expand-Archive -Path "$wgetDir\wget.zip" -DestinationPath $wgetDir -Force
            Remove-Item "$wgetDir\wget.zip"
          }
          echo "C:\wget" >> $env:GITHUB_PATH
          & "$wgetDir\wget.exe" --version

      - name: Install GnuWin32 UnZip
        shell: powershell
        run: |
          $gnuBin = "${env:ProgramFiles(x86)}\GnuWin32\bin"
          if (-not (Test-Path "$gnuBin\unzip.exe")) {
            winget install -e --id GnuWin32.UnZip --silent --accept-package-agreements --accept-source-agreements
          }
          if (Test-Path "$gnuBin\unzip.exe") { echo $gnuBin >> $env:GITHUB_PATH; Write-Host "UnZip at $gnuBin" }

      - name: Cache LLVM
        id: cache-llvm
        uses: actions/cache@v4
        with:
          path: "C:\Program Files\LLVM"
          key: llvm-10-windows-recall

      - name: Install LLVM and Clang
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        shell: powershell
        run: |
          $llvmPath = "C:\Program Files\LLVM"
          if (Test-Path "$llvmPath\bin\clang.exe") { Write-Host "LLVM already installed"; exit 0 }
          New-Item -ItemType Directory -Force -Path $llvmPath | Out-Null
          $url = "https://github.com/llvm/llvm-project/releases/download/llvmorg-10.0.0/LLVM-10.0.0-win64.exe"
          $out = "$env:TEMP\LLVM-10.0.0-win64.exe"
          Invoke-WebRequest -Uri $url -OutFile $out -UseBasicParsing
          Start-Process -FilePath $out -ArgumentList "/S", "/D=$llvmPath" -Wait -NoNewWindow
          Remove-Item $out -Force
          if (!(Test-Path "$llvmPath\bin\clang.exe")) { throw "LLVM install failed" }
          Write-Host "LIBCLANG_PATH=$llvmPath\bin" >> $env:GITHUB_ENV
          echo "$llvmPath\bin" >> $env:GITHUB_PATH

      - name: Set LIBCLANG_PATH
        if: steps.cache-llvm.outputs.cache-hit == 'true'
        shell: powershell
        run: |
          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" >> $env:GITHUB_ENV

      - name: Install Vulkan SDK
        shell: powershell
        run: |
          $vulkanVersion = "1.3.290.0"
          $vulkanPath = "C:\VulkanSDK\$vulkanVersion"
          if (Test-Path "$vulkanPath\Lib\vulkan-1.lib") { Write-Host "Vulkan SDK already installed" }
          else {
            $installerUrl = "https://sdk.lunarg.com/sdk/download/$vulkanVersion/windows/VulkanSDK-$vulkanVersion-Installer.exe"
            $installerPath = "$env:TEMP\VulkanSDK-Installer.exe"
            Invoke-WebRequest -Uri $installerUrl -OutFile $installerPath -UseBasicParsing
            Start-Process -FilePath $installerPath -ArgumentList "--accept-licenses", "--default-answer", "--confirm-command", "install" -Wait -NoNewWindow
            Remove-Item $installerPath -Force -ErrorAction SilentlyContinue
          }
          echo "VULKAN_SDK=$vulkanPath" >> $env:GITHUB_ENV
          if (!(Test-Path "$vulkanPath\Lib\vulkan-1.lib")) { throw "Vulkan SDK install failed" }

      - name: Setup Python (for MKL)
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install CMake
        shell: powershell
        run: |
          $paths = @("C:\Program Files\CMake\bin", "C:\Program Files\Kitware\CMake\bin")
          foreach ($d in $paths) {
            if (Test-Path "$d\cmake.exe") { echo $d >> $env:GITHUB_PATH; Write-Host "CMake at $d"; exit 0 }
          }
          winget install -e --id Kitware.CMake --silent --accept-package-agreements --accept-source-agreements
          foreach ($d in $paths) {
            if (Test-Path "$d\cmake.exe") { echo $d >> $env:GITHUB_PATH; Write-Host "CMake at $d"; exit 0 }
          }
          throw "CMake not found after install"

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: recall-windows-${{ hashFiles('screenpipe/**/Cargo.lock') }}
          cache-directories: |
            screenpipe/target
            screenpipe/apps/screenpipe-app-tauri/src-tauri/target

      - name: Build (setup-screenpipe.ps1)
        shell: powershell
        run: |
          $llvmBin = "C:\Program Files\LLVM\bin"
          $env:LIBCLANG_PATH = $llvmBin
          $env:Path = "$llvmBin;$env:Path"
          if (-not (Test-Path "$llvmBin\libclang.dll")) { throw "libclang not found at $llvmBin - bindgen/whisper-rs-sys requires it" }
          .\scripts\setup-screenpipe.ps1 -SkipPrereqCheck
        env:
          LIBCLANG_PATH: "C:\Program Files\LLVM\bin"
          VCPKG_STATIC_LINKAGE: "true"
          KNF_STATIC_CRT: "1"
          CMAKE_ARGS: "-DGGML_NATIVE=OFF -DGGML_AVX512=OFF -DGGML_AVX512_VBMI=OFF -DGGML_AVX512_VNNI=OFF -DGGML_AVX512_BF16=OFF"

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: screenpipe-installer-windows
          path: screenpipe/apps/screenpipe-app-tauri/src-tauri/target/release/bundle/nsis/*.exe

      - name: Create Release (tag v* or manual with create_release)
        if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')
        uses: softprops/action-gh-release@v2
        with:
          draft: true
          generate_release_notes: true
          files: screenpipe/apps/screenpipe-app-tauri/src-tauri/target/release/bundle/nsis/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
